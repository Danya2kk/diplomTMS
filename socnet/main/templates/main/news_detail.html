{% extends 'main/layout.html' %}
{% load static %}

{% block content %}
    <div class="news-detail-container">
        <section class="news-detail-content">
            <img src="{{ news_item.image.url }}" alt="Описание фото" class="news-inner-image">
            <div class="news-detail-text">
                <p>{{ news_item.content }}</p>
                <p>Тэги: {{ news_item.tags.all|join:", " }}</p> <!-- Теги через запятую -->
                <p>Автор: {{ news_item.profile.firstname }} {{ news_item.profile.lastname }}</p>
                <p>Дата создания: {{ news_item.created_at }}</p>

            </div>
            <div class="news-detail-text">
                <a class="btn-news" href="{% url 'news_create' %}">Добавить новость</a>
                {% if is_owner %}
                    <a class="btn-news" href="{% url 'news_edit' news_item.pk %}">Редактировать</a>
                    <a class="btn-news" href="{% url 'news_delete' news_item.pk %}">Удалить</a>
                {% endif %}

                <div class="separator-line"></div>

                <!-- Новый блок под линией -->
                {% if is_owner %}
                    <div class="news-reaction-block">
                        <p>Реакция на новость</p>
                        <!-- Кнопки для Лайка и Дизлайка -->
                        <button class="reaction-btn {% if user_reaction == 'like' %}active{% endif %}" data-object-id="{{ news_item.id }}" data-model-name="news" data-reaction-type="like">
                            <img class="reaction-img" src="{% static 'images/like.gif' %}" alt="Like">
                        </button>
                        <button class="reaction-btn {% if user_reaction == 'dislike' %}active{% endif %}" data-object-id="{{ news_item.id }}" data-model-name="news" data-reaction-type="dislike">
                            <img class="reaction-img" src="{% static 'images/dislike.gif' %}" alt="Dislike">
                        </button>
                    </div>
                     <div class="news-reaction-block">
                         <p>Средний рейтинг: {{ total_score }}</p> <!-- Отображение среднего рейтинга -->
                    </div>


                {% endif %}
            </div>
        </section>
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('.reaction-btn').click(function(event) {
        event.preventDefault();

        var button = $(this);
        var objectId = button.data('object-id');
        var reactionType = button.data('reaction-type');
        var url = "{% url 'reaction_toggle' %}"; // URL эндпоинта для обработки реакции

        $.ajax({
            url: url,
            method: 'POST',
            data: {
                'object_id': objectId,
                'reaction_type': reactionType,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Обновление UI на основе реакции пользователя
                $('.reaction-btn[data-object-id="' + objectId + '"]').removeClass('active');
                if (response.reaction_type === reactionType) {
                    button.addClass('active');
                }
                // Обновление рейтинга на странице
                $('#total-score').text(response.total_score);
            },
            error: function(xhr, status, error) {
                console.error('Ошибка при отправке запроса: ', error);
            }
        });
    });
});
</script>
{% endblock %}
