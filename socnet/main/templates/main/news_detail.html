{% extends 'main/layout.html' %}
{% load static %}

{% block content %}
<div class="news-detail-container">
    <section class="news-detail-content">
        <!-- Содержимое новости: изображение, описание, теги и т.д. -->
        <img src="{{ news_item.image.url }}" alt="Описание фото" class="news-inner-image">
        <div class="news-detail-text">
            <p>{{ news_item.content }}</p>
            <p>Тэги: {{ news_item.tags.all|join:", " }}</p>
            <p>Автор: {{ news_item.profile.firstname }} {{ news_item.profile.lastname }}</p>
            <p>Дата создания: {{ news_item.created_at }}</p>
        </div>
        <div class="news-detail-text">
            <a class="btn-news" href="{% url 'news_create' %}">Добавить новость</a>
            {% if is_owner %}
                <a class="btn-news" href="{% url 'news_edit' news_item.pk %}">Редактировать</a>
                <a class="btn-news" href="{% url 'news_delete' news_item.pk %}">Удалить</a>
            {% endif %}
            <div class="separator-line"></div>
            <!-- Новый блок под линией -->
            {% if is_owner %}
                <div class="news-reaction-block">
                    <p>Реакция на новость</p>
                    <button class="reaction-btn {% if user_reaction == 'like' %}active{% endif %}" data-object-id="{{ news_item.id }}" data-model-name="news" data-reaction-type="like">
                        <img class="reaction-img" src="{% static 'images/like.gif' %}" alt="Like">
                    </button>
                    <button class="reaction-btn {% if user_reaction == 'dislike' %}active{% endif %}" data-object-id="{{ news_item.id }}" data-model-name="news" data-reaction-type="dislike">
                        <img class="reaction-img" src="{% static 'images/dislike.gif' %}" alt="Dislike">
                    </button>
                </div>
                <div class="news-reaction-block">
                    <p>Средний рейтинг: {{ total_score }}</p>
                </div>
            {% endif %}
        </div>
    </section>
</div>

<div class="comments-wrapper">
    <!-- Кнопка для показа/скрытия комментариев -->
    <button id="toggle-comments-btn" class="btn-comment-news">Показать комментарии</button>

    <!-- Область комментариев -->
    <div id="comments-section" class="comments-section">
        {% for comment in news_item.comments.all %}
            <div class="comment">
                <p><strong>{{ comment.author.firstname }} {{ comment.author.lastname }}:</strong> {{ comment.text }}</p>
                <p class="comment-date">{{ comment.created_at }}</p>
            </div>
        {% empty %}
            <p>Комментариев пока нет.</p>
        {% endfor %}
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('.reaction-btn').click(function(event) {
        event.preventDefault();

        var button = $(this);
        var objectId = button.data('object-id');
        var reactionType = button.data('reaction-type');
        var url = "{% url 'reaction_toggle' %}"; // URL эндпоинта для обработки реакции

        $.ajax({
            url: url,
            method: 'POST',
            data: {
                'object_id': objectId,
                'reaction_type': reactionType,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                // Обновление UI на основе реакции пользователя
                $('.reaction-btn[data-object-id="' + objectId + '"]').removeClass('active');
                if (response.reaction_type === reactionType) {
                    button.addClass('active');
                }
                // Обновление рейтинга на странице
                $('#total-score').text(response.total_score);
            },
            error: function(xhr, status, error) {
                console.error('Ошибка при отправке запроса: ', error);
            }
        });
    });

    // Функция для установки ширины comments-wrapper и кнопки
    function adjustContentWidth() {
        // Получаем ширину контейнера .news-detail-content
        var contentWidth = $('.news-detail-content').outerWidth();

        // Устанавливаем эту ширину для comments-wrapper
        $('.comments-wrapper').css('width', contentWidth + 'px');

        // Устанавливаем ширину кнопки на 100% от родительского контейнера
        $('#toggle-comments-btn').css('width', '100%');
    }

    // Вызываем функцию при загрузке страницы
    adjustContentWidth();

    // Вызываем функцию при изменении размера окна
    $(window).resize(function() {
        adjustContentWidth();
    });

    // Скрипт для аккордеона комментариев
    $('#toggle-comments-btn').click(function() {
        console.log('Button clicked');
        $('#comments-section').slideToggle();  // Показываем или скрываем комментарии
        var isVisible = $('#comments-section').is(':visible');
        $(this).text(isVisible ? 'Скрыть комментарии' : 'Показать комментарии');
    });
});
</script>
{% endblock %}
