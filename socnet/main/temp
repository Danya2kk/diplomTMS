{% extends 'main/layout.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}
<h2 class="Auth_title">Почта {{ username }} </h2>
<div class="news-detail-container">

    <section class="mail-detail-content">
        <div class="mail-detail-left">
            <button class="recipient_mail add-font" data-username="{{ username }}">Входящие сообщения</button>
            <button class="sender_mail add-font" data-username="{{ username }}">Отправленные сообщения</button>
            <div class="separator-line"></div>

            <button class="send_mail add-font">Отправить сообщение</button>

            <!-- Модальное окно -->
            <div id="sendMailModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Отправить сообщение</h2>
                    <form id="sendMailForm">
                        <label for="recipient">Получатель (username):</label>
                        <input type="text" id="recipient" name="recipient" required>

                        <label for="content">Сообщение:</label>
                        <textarea id="content" name="content" required></textarea>

                        <button class="add-font" type="submit">Отправить</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="mail-detail-right mail-detail-text">
            <div class="news-detail-text" id="mailbox-content">
                {% for mail in mails %}
                    <p>{{ mail.content }} от {{ mail.sender.user.username }}</p>
                {% empty %}
                    <p>Сообщений нет</p>
                {% endfor %}
            </div>
        </div>
        <div id="message-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="modal-body">
                    <!-- Содержимое модального окна будет добавлено через JavaScript -->
                </div>
            </div>
        </div>
    </section>
</div>


<script>
    // Открытие модального окна
document.querySelector('.send_mail').addEventListener('click', function() {
    document.getElementById('sendMailModal').style.display = 'block';
});

// Закрытие модального окна
document.querySelector('.close').addEventListener('click', function() {
    document.getElementById('sendMailModal').style.display = 'none';
});

// Закрытие модального окна при клике вне его
window.addEventListener('click', function(event) {
    if (event.target == document.getElementById('sendMailModal')) {
        document.getElementById('sendMailModal').style.display = 'none';
    }
});

// Отправка сообщения
document.getElementById('sendMailForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const recipient = document.getElementById('recipient').value;
    const content = document.getElementById('content').value;

    fetch('/mailbox/send_mail', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'  // Используйте Django-токен CSRF
        },
        body: JSON.stringify({
            'username': recipient,
            'content': content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.detail) {
            showAjaxPopup(data.detail); // Сообщение об успехе или ошибке
        } else {
            showAjaxPopup('Произошла ошибка при отправке сообщения.');
        }
        document.getElementById('sendMailModal').style.display = 'none'; // Закрыть модальное окно
    });
});


document.addEventListener('DOMContentLoaded', function() {
    const recipientBtn = document.querySelector('.recipient_mail');
    const senderBtn = document.querySelector('.sender_mail');
    const mailboxContent = document.getElementById('mailbox-content');

    // Функция для обновления содержимого почты
    function updateMailboxContent(url, type) {
        fetch(url)
        .then(response => response.json())
        .then(data => {
            let mails = data.detail;
            mailboxContent.innerHTML = ''; // Очищаем старое содержимое
            if (mails.length > 0) {
                mails.forEach(mail => {
                    if (type === 'sender') {
                        // Для отправленных сообщений
                        mailboxContent.innerHTML += `<p>${mail.content} для ${mail.recipient.firstname} ${mail.recipient.lastname}</p>`;
                    } else if (type === 'recipient') {
                        // Для входящих сообщений
                        mailboxContent.innerHTML += `<p>${mail.content} от ${mail.sender.firstname} ${mail.sender.lastname}</p>`;
                    }
                });
            } else {
                mailboxContent.innerHTML = '<p>Сообщений нет</p>';
            }
        })
        .catch(error => {
            console.error('Error fetching mails:', error);
        });
    }

    // Обработчик для входящих сообщений
    recipientBtn.addEventListener('click', function() {
        updateMailboxContent("{% url 'recipient_mail' %}", 'recipient');
    });

    // Обработчик для отправленных сообщений
    senderBtn.addEventListener('click', function() {
        updateMailboxContent("{% url 'sender_mail' %}", 'sender');
    });
});


    document.addEventListener('DOMContentLoaded', function() {
    const recipientBtn = document.querySelector('.recipient_mail');
    const senderBtn = document.querySelector('.sender_mail');
    const mailboxContent = document.getElementById('mailbox-content');
    const modal = document.getElementById('message-modal');
    const modalBody = document.getElementById('modal-body');
    const closeModal = document.querySelector('.close');

    function updateMailboxContent(url, isSender) {
    fetch(url)
    .then(response => response.json())
    .then(data => {
        let mails = data.detail;
        mailboxContent.innerHTML = ''; // Очищаем старое содержимое
        if (mails.length > 0) {
            mails.forEach(mail => {
                let mailHtml;
                if (isSender) {
                    mailHtml = `<p data-id="${mail.id}" class="mail-item">${mail.content} для ${mail.recipient.firstname} ${mail.recipient.lastname}</p>`;
                } else {
                    let mailStyle = mail.is_read ? '' : 'font-weight: bold; color: red;';
                    mailHtml = `<p data-id="${mail.id}" class="mail-item" style="${mailStyle}">${mail.content} от ${mail.sender.firstname} ${mail.sender.lastname}</p>`;
                }
                mailboxContent.innerHTML += mailHtml;
            });
        } else {
            mailboxContent.innerHTML = '<p>Сообщений нет</p>';
        }
        addMailClickEvent();
    })
    .catch(error => {
        console.error('Error fetching mails:', error);
    });
}

    function addMailClickEvent() {
    const mailItems = document.querySelectorAll('.mail-item');
    mailItems.forEach(item => {
        item.addEventListener('click', function() {
            const mailId = this.getAttribute('data-id');
            if (mailId) {
                fetch(`/mailbox/message/${mailId}/`)
                .then(response => response.json())
                .then(data => {
                    const mail = data.detail;
                    let modalHtml;
                     if (mail.parent) {
                        modalHtml += `<div class="mail-answer">
                        <p class="btn-news add-font">Ответ на сообщение: ${mail.parent.content}</p>
                        </div>`;
                    }
                    if (data.isSender) {
                        modalHtml = `<div class="mail-answer">
                            <p class="btn-news add-font">Получатель: ${mail.recipient.firstname} ${mail.recipient.lastname}</p>
                            <p class="btn-news add-font">Сообщение: ${mail.content}</p>
                            </div>
                        `;
                    } else {
                        modalHtml = `
                            <div class="mail-answer">
                            <p class="btn-news add-font">Отправитель: ${mail.sender.firstname} ${mail.sender.lastname}</p>
                            <p class="btn-news add-font">Сообщение: ${mail.content}</p>
                            <button id="reply-button" class="btn_mail add-font" >Ответить</button>
                            </div>
                        `;
                    }

                    modalBody.innerHTML = modalHtml;
                    modal.style.display = 'block';

                    if (!data.isSender) {
                        document.getElementById('reply-button').addEventListener('click', function() {
                            const replyContent = prompt('Введите текст ответа:');
                            if (replyContent) {
                                fetch('/mailbox/send_mail_parent', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': getCookie('csrftoken')
                                    },
                                    body: JSON.stringify({
                                        parent: mail.id,
                                        username: mail.sender.username,
                                        content: replyContent
                                    })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    showAjaxPopup(data.detail);
                                    modal.style.display = 'none';
                                    updateMailboxContent(currentUrl, false); // Перезагружаем входящие сообщения
                                })
                                .catch(error => console.error('Error sending reply:', error));
                            }
                        });
                    }
                })
                .catch(error => console.error('Error fetching mail details:', error));
            } else {
                console.error('Mail ID is undefined');
            }
        });
    });
}

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Инициализация контента при загрузке страницы
    updateMailboxContent("{% url 'recipient_mail' %}", false);

    recipientBtn.addEventListener('click', function() {
        updateMailboxContent("{% url 'recipient_mail' %}", false);
    });

    senderBtn.addEventListener('click', function() {
        updateMailboxContent("{% url 'sender_mail' %}", true);
    });

    closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
    });

    window.addEventListener('click', function(event) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
});


</script>

{% endblock %}
